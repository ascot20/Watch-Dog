<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:WatchDog.ViewModels"
             xmlns:controls="using:WatchDog.Views.Controls"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="450"
             x:Class="WatchDog.Views.NewProjectView"
             x:DataType="vm:NewProjectViewModel">

    <ScrollViewer>
        <Grid RowDefinitions="56,*" Background="{DynamicResource BackgroundDarkBrush}">
            <!-- Header -->
            <controls:HeaderControl Grid.Row="0" PageTitle="New project" NavigateToDashboardCommand="{Binding NavigateToDashboardCommand}"/>

            <StackPanel Grid.Row="1" HorizontalAlignment="Center"
                        Width="720"
                        Margin="24">
                <TextBlock Text="Create a new project" Classes="Heading" />
                <TextBlock Text="A project contains members, including tasks assigned to them." TextWrapping="Wrap" />

                <Separator Margin="4" />

                <TextBlock Text="Required fields are marked with an asterik (*)."></TextBlock>

                <Grid ColumnDefinitions="Auto,Auto,Auto">
                    <StackPanel>
                        <TextBlock Text="Owner" />
                        <Border Classes="Card" Background="{DynamicResource ContainerDarkerBrush}">
                            <TextBlock Text="{Binding CurrentUser.Username}"></TextBlock>
                        </Border>
                    </StackPanel>
                    <TextBlock Grid.Column="1" Text="/" VerticalAlignment="Bottom" Margin="8,0" />
                    <StackPanel Grid.Column="2">
                        <TextBlock Text="Project name *" />
                        <TextBox Text="{Binding ProjectName}"></TextBox>
                    </StackPanel>
                </Grid>

                <TextBlock Text="Description" Margin="0,16,0,4" />
                <TextBox Text="{Binding ProjectDescription}" Height="80" TextWrapping="Wrap"></TextBox>

                <Separator Margin="0,16,0,16"></Separator>

                <TextBlock Text="Team Members and Tasks" Classes="Label" />
                <TextBlock Text="Note: Each team member must be assigned at least one task."
                           Opacity="0.7" Margin="0,0,0,8" />

                <!-- Add New Team Member Section -->
                <Border Classes="Card" Margin="0,0,0,16">
                    <StackPanel>
                        <TextBlock Text="Add New Team Member" FontWeight="Bold" Margin="0,0,0,8" />

                        <!-- Step 1: Search for user (only shown if no pending user) -->
                        <Grid ColumnDefinitions="*,Auto" Margin="0,8,0,0"
                              IsVisible="{Binding PendingUser, Converter={x:Static ObjectConverters.IsNull}}">
                            <TextBox Grid.Column="0"
                                     Text="{Binding SearchTerm}"
                                     Watermark="Search for users by username or email" />
                            <Button Grid.Column="1"
                                    Command="{Binding SearchUsersCommand}"
                                    Margin="8,0,0,0">
                                <TextBlock Text="Search"></TextBlock>
                            </Button>
                        </Grid>

                        <!-- Search Results (only shown if no pending user) -->
                        <Border Classes="Card" IsVisible="{Binding HasSearchResults}"
                                MaxHeight="200" Margin="0,8,0,0">
                            <ListBox ItemsSource="{Binding SearchResults}"
                                     SelectedItem="{Binding SelectedUser}">
                                <ListBox.ItemTemplate>
                                    <DataTemplate>
                                        <Grid ColumnDefinitions="*,Auto">
                                            <TextBlock Text="{Binding Username}" VerticalAlignment="Center" />
                                            <Button Grid.Column="1"
                                                    Command="{Binding $parent[UserControl].((vm:NewProjectViewModel)DataContext).SelectUserForTaskCommand}">
                                                <TextBlock Text="Select" />
                                            </Button>
                                        </Grid>
                                    </DataTemplate>
                                </ListBox.ItemTemplate>
                            </ListBox>
                        </Border>

                        <!-- Step 2: Assign Task to Selected User (only shown if pending user exists) -->
                        <StackPanel IsVisible="{Binding PendingUser, Converter={x:Static ObjectConverters.IsNotNull}}">
                            <TextBlock Text="Assigning task to:" Margin="0,8,0,4" />
                            <TextBlock Text="{Binding PendingUser.Username}" FontWeight="Bold" Margin="0,0,0,8" />

                            <TextBlock Text="Task Description *" Margin="0,8,0,4" />
                            <Grid ColumnDefinitions="*,Auto,Auto">
                                <TextBox Grid.Column="0"
                                         Text="{Binding TaskDescription}"
                                         Watermark="Enter task description" />
                                <Button Grid.Column="1"
                                        Command="{Binding AddUserWithTaskCommand}"
                                        Margin="8,0,0,0">
                                    <TextBlock Text="Add to Team" />
                                </Button>
                                <Button Grid.Column="2"
                                        Command="{Binding CancelAddUserCommand}"
                                        Margin="8,0,0,0">
                                    <TextBlock Text="Cancel" />
                                </Button>
                            </Grid>
                        </StackPanel>
                    </StackPanel>
                </Border>
                <!-- Team Member List -->
                <Border Classes="Cardtwo" MinHeight="100" Padding="16" Margin="0,0,0,16">
                    <ItemsControl ItemsSource="{Binding TeamMembers}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Expander Header="{Binding Member.Username}" Margin="0,4">
                                    <StackPanel>
                                        <ItemsControl ItemsSource="{Binding TaskDescriptions}">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <Grid ColumnDefinitions="*,Auto" Margin="16,4">
                                                        <TextBlock Text="{Binding }" />
                                                        <Button Grid.Column="1"
                                                                Command="{Binding $parent[UserControl].((vm:NewProjectViewModel)DataContext).RemoveTaskCommand}"
                                                                CommandParameter="{Binding}">
                                                            <TextBlock Text="âœ•" />
                                                        </Button>
                                                    </Grid>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>

                                        <!-- Add additional task for this team member -->
                                        <Grid ColumnDefinitions="*,Auto" Margin="16,8,16,0">
                                            <TextBox Grid.Column="0"
                                                     Watermark="Add another task for this team member"
                                                     Text="{Binding $parent[UserControl].((vm:NewProjectViewModel)DataContext).TaskDescription}" />
                                            <Button Grid.Column="1"
                                                    Command="{Binding $parent[UserControl].((vm:NewProjectViewModel)DataContext).AddTaskToTeamMemberCommand}"
                                                    CommandParameter="{Binding}">
                                                <TextBlock Text="Add Task" />
                                            </Button>
                                        </Grid>
                                    </StackPanel>
                                </Expander>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </Border>


                <!-- Error message -->
                <TextBlock Text="{Binding ErrorMessage}"
                           IsVisible="{Binding ErrorMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                           Classes="ErrorMessage" />

                <Separator Margin="0,16,0,16" />
                <Button Command="{Binding CreateProjectCommand}"
                        HorizontalAlignment="Center"
                        IsEnabled="{Binding ProjectName, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                    <TextBlock Text="Create project"></TextBlock>
                </Button>
            </StackPanel>
        </Grid>
    </ScrollViewer>

</UserControl>