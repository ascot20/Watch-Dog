<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:WatchDog.ViewModels"
             xmlns:controls="using:WatchDog.Views.Controls"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="450"
             x:Class="WatchDog.Views.DashboardView"
             x:DataType="vm:DashboardViewModel">


    <Grid RowDefinitions="56,*" Background="{DynamicResource BackgroundDarkerBrush}">
        <!-- Header -->
        <controls:HeaderControl Grid.Row="0" PageTitle="Dashboard"
                                NavigateToDashboardCommand="{Binding NavigateToDashboardCommand}" 
                                LogOutCommand="{Binding LogoutCommand}"/>
        <!-- Main Content -->
        <Grid Grid.Row="1" ColumnDefinitions="270, *, 300">
            <!-- Left Sidebar -->
            <Border Grid.Column="0" Classes="Card" CornerRadius="0">
                <ScrollViewer>
                    <StackPanel>

                        <Grid ColumnDefinitions="*, Auto">
                            <TextBlock Text="Your Projects" Classes="Headingthree" HorizontalAlignment="Left"
                                       Margin="1,20" />
                            <Button Classes="PrimaryButton"
                                    Grid.Column="1"
                                    Command="{Binding NavigateToNewProjectCommand}"
                                    IsVisible="{Binding IsAdmin}">
                                <StackPanel Orientation="Horizontal" Spacing="4">
                                    <PathIcon Data="{StaticResource AddProjectIcon}" Width="16" Height="16" />
                                    <TextBlock Text="New" VerticalAlignment="Center" />
                                </StackPanel>
                            </Button>
                        </Grid>

                        <!-- Projects List -->
                        <ItemsControl ItemsSource="{Binding MyProjects}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Button
                                        Classes="Project"
                                        Command="{Binding $parent[UserControl].((vm:DashboardViewModel)DataContext).NavigateToProjectCommand}"
                                        CommandParameter="{Binding}">
                                        <Grid Margin="0,4" ColumnDefinitions="16, *">
                                            <TextBlock Grid.Column="0" Text="ðŸ“" VerticalAlignment="Center" />
                                            <TextBlock Grid.Column="1" Text="{Binding Title}" Margin="8,0,0,0"
                                                       VerticalAlignment="Center" />
                                        </Grid>
                                    </Button>

                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </StackPanel>
                </ScrollViewer>
            </Border>


            <!-- Main Content Area -->
            <ScrollViewer Grid.Column="1" Padding="24" VerticalScrollBarVisibility="Hidden" Margin="0,0,0,16">
                <StackPanel>
                    <!-- Error Card -->
                    <Border Classes="CardError"
                            IsVisible="{Binding ErrorMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                        <!-- Error message-->
                        <TextBlock Text="{Binding ErrorMessage}"
                                   Classes="ErrorLabel" />
                    </Border>


                    <TextBlock Text="Feed" FontSize="24" FontWeight="Bold" Margin="0,0,0,16" />

                    <!--Loading indicator-->
                    <ProgressBar IsIndeterminate="True"
                                 IsVisible="{Binding IsLoading}"
                                 Margin="0,16" />

                    <ItemsControl ItemsSource="{Binding FeedProjects}" Margin="0,0,0,48">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Classes="Card" Margin="0,0,0,16">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto" />
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="Auto" />
                                        </Grid.ColumnDefinitions>

                                        <TextBlock Grid.Column="0" Text="ðŸ“" FontSize="24"
                                                   VerticalAlignment="Top" Margin="0,0,16,0" />

                                        <StackPanel Grid.Column="1" Spacing="4">
                                            <TextBlock Text="{Binding Title}" Classes="Headingthree" />
                                            <TextBlock Text="{Binding Description}" Classes="Label"
                                                       TextWrapping="Wrap" Margin="0,4,0,0" />
                                            <TextBlock Text="{Binding CreatedDate}"
                                                       Classes="Labeltwo" />
                                        </StackPanel>

                                        <Border Grid.Column="2"
                                                CornerRadius="16" VerticalAlignment="Top"
                                                Background="{Binding Status, Converter={StaticResource StatusToColorConverter}}"
                                                Width="100"
                                                Padding="8,8"
                                                Margin="0,4,0,0">
                                            <TextBlock Text="{Binding Status }"
                                                       Classes="Label"
                                                       HorizontalAlignment="Center"
                                                       Margin="0,0,0,0" />
                                        </Border>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>
            </ScrollViewer>

            <!-- Right Sidebar -->
            <StackPanel Grid.Column="2" Margin="4 16,16,16">
                <!-- Admin User Management Section -->
                <Border Classes="Cardtwo" IsVisible="{Binding IsAdmin}">
                    <StackPanel>
                        <Grid ColumnDefinitions="*, Auto" Margin="12,12,12,8">
                            <TextBlock Text="User Management" Classes="Headingthree" HorizontalAlignment="Left" />
                            <Button Grid.Column="1"
                                    Classes="PrimaryButton"
                                    Command="{Binding NavigateToRegisterCommand}">
                                <StackPanel Orientation="Horizontal" Spacing="4">
                                    <PathIcon Data="{StaticResource AddIcon}" Width="16" Height="16" />
                                    <TextBlock Text="Add" VerticalAlignment="Center" />
                                </StackPanel>
                            </Button>
                        </Grid>

                        <!-- Loading indicator -->
                        <ProgressBar IsIndeterminate="True"
                                     IsVisible="{Binding IsLoadingUsers}"
                                     Margin="12,8" />

                        <!-- User search -->
                        <Grid ColumnDefinitions="*,Auto" Margin="12,0,12,8">
                            <TextBox Grid.Column="0"
                                     Text="{Binding SearchTerm}"
                                     Watermark="Search users..."
                                     Margin="0,0,8,0" />
                            <Button Grid.Column="1"
                                    Command="{Binding SearchAllUsersCommand}">
                                <PathIcon Data="{StaticResource SearchIcon}" Width="16" Height="16" />
                            </Button>
                        </Grid>

                        <!-- Users list -->
                        <Border Classes="Card"
                                Background="{DynamicResource BackgroundDarkerBrush}"
                                MaxHeight="300"
                                Margin="12,0,12,12">
                            <ScrollViewer>
                                <ItemsControl ItemsSource="{Binding FilteredUsers}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border Padding="8"
                                                    Margin="0,2"
                                                    CornerRadius="4"
                                                    Background="{DynamicResource ContainerBrush}">
                                                <Grid ColumnDefinitions="Auto, *, Auto">
                                                    <Border Grid.Column="0"
                                                            Width="32" Height="32"
                                                            CornerRadius="16"
                                                            Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}"
                                                            Margin="0,0,12,0">
                                                        <TextBlock
                                                            Text="{Binding Username[0]}"
                                                            HorizontalAlignment="Center"
                                                            VerticalAlignment="Center" />
                                                    </Border>
                                                    <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                                        <TextBlock Text="{Binding Username}" FontWeight="Medium" />
                                                        <TextBlock Text="{Binding Email}" FontSize="12"
                                                                   Opacity="0.7" />
                                                    </StackPanel>
                                                    <StackPanel Grid.Column="2" Orientation="Horizontal"
                                                                Spacing="8">


                                                    </StackPanel>
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </ScrollViewer>
                        </Border>

                        <!-- User statistics -->
                        <Grid ColumnDefinitions="*,*" Margin="12,0,12,12">
                            <Border Grid.Column="0"
                                    Classes="Card"
                                    Background="{DynamicResource ContainerBrush}"
                                    Margin="0,0,4,0"
                                    Padding="12">
                                <StackPanel>
                                    <TextBlock Text="{Binding AllUsers.Count}"
                                               FontSize="24"
                                               FontWeight="Bold"
                                               HorizontalAlignment="Center" />
                                    <TextBlock Text="Total Users"
                                               FontSize="12"
                                               Opacity="0.7"
                                               HorizontalAlignment="Center" />
                                </StackPanel>
                            </Border>
                            <Border Grid.Column="1"
                                    Classes="Card"
                                    Background="{DynamicResource ContainerBrush}"
                                    Margin="4,0,0,0"
                                    Padding="12">
                                <StackPanel>
                                    <TextBlock Text="{Binding FeedProjects.Count}"
                                               FontSize="24"
                                               FontWeight="Bold"
                                               HorizontalAlignment="Center" />
                                    <TextBlock Text="Total Projects"
                                               FontSize="12"
                                               Opacity="0.7"
                                               HorizontalAlignment="Center" />
                                </StackPanel>
                            </Border>
                        </Grid>
                    </StackPanel>
                </Border>

                <!-- Regular User Tasks Section -->
                <Border Classes="Cardtwo" IsVisible="{Binding !IsAdmin}">
                    <StackPanel>
                        <TextBlock Text="Your Tasks" Classes="Headingthree" Margin="12,12,0,12" />
                        <ItemsControl ItemsSource="{Binding MyTasks}" Margin="12, 0, 12, 12">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Button
                                        Command="{Binding $parent[UserControl].((vm:DashboardViewModel)DataContext).NavigateToTaskCommand}"
                                        CommandParameter="{Binding}"
                                        HorizontalAlignment="Stretch"
                                        HorizontalContentAlignment="Stretch"
                                        Background="Transparent"
                                        BorderThickness="0"
                                        Padding="0"
                                        Margin="0,0,0,4">
                                        <Grid Margin="0,0,0,12" ColumnDefinitions="*, Auto">
                                            <StackPanel Grid.Column="0" Spacing="4">
                                                <TextBlock Text="{Binding TaskDescription}" TextWrapping="Wrap"
                                                           HorizontalAlignment="Left"
                                                           VerticalAlignment="Center" />
                                                <TextBlock Text="{Binding ProjectId, StringFormat='Project #{0}'}"
                                                           Opacity="0.6"
                                                           FontSize="12" />
                                            </StackPanel>

                                            <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8"
                                                        VerticalAlignment="Center">
                                                <Border
                                                    Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}"
                                                    CornerRadius="12"
                                                    Padding="8,4">
                                                    <TextBlock
                                                        Text="{Binding PercentageComplete, StringFormat='{}{0}%'}"
                                                        FontSize="12" />
                                                </Border>
                                                <!-- Arrow icon -->
                                                <PathIcon
                                                    Data="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z"
                                                    Width="16"
                                                    Height="16"
                                                    Opacity="0.6" />
                                            </StackPanel>
                                        </Grid>
                                    </Button>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </StackPanel>
                </Border>
            </StackPanel>
        </Grid>
    </Grid>


</UserControl>